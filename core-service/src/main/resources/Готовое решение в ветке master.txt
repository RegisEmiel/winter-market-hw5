Готовое решение в ветке master.